apiVersion: v1
kind: ServiceAccount
metadata:
  name: krules-system
  namespace: {{ namespace }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: krules-system
rules:
- apiGroups: ["eventing.knative.dev",] # "serving.knative.dev", "sources.knative.dev"]
  resources:
    - brokers
    #- triggers
    #- services
    #- apiserversources
  verbs:
    - list
    - get
#    - create
#    - delete
#    - patch
#    - watch
#- apiGroups: ["", "rbac.authorization.k8s.io"]
#  resources:
#    - serviceaccounts
#    - roles
#    - rolebindings
#  verbs:
#    - list
#    - get
#    - create
#    - delete
- apiGroups: ["krules.airspot.dev"]
  resources:
   - configurationproviders
#    - configurationproviders/status
  verbs:
  - list
  - get
  - patch
#    - watch
#    - update
#    - patch
- apiGroups: [""]
  resources:
    - configmaps
  verbs:
    - list
    - get
    - create
    - delete
#    - watch
#    - update
    - patch
- apiGroups:
    - apps
  resources:
    - deployments
  verbs:
    - list
    - get
    - patch
- apiGroups:
    - serving.knative.dev
  resources:
    - services
  verbs:
    - list
    - get
    - patch
- apiGroups: [""]
  resources:
    - events
  verbs:
    - create
#- apiGroups: [""]
#  resources:
#    - namespaces
#  verbs:
#    - list
#    - get
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: krules-system
subjects:
- kind: ServiceAccount
  name: krules-system
  namespace: {{ namespace }}
roleRef:
  kind: ClusterRole
  name: krules-system
  apiGroup: rbac.authorization.k8s.io
---

apiVersion: apps/v1
kind: Deployment
metadata: 
    name: {{ name }}
    namespace: {{ namespace }}
    labels: 
        app: {{ name }}
spec:
    replicas: 1
    selector:
        matchLabels: 
            app: {{ name }}
    template:
        metadata:
            labels:
                app: {{ name }}
        spec:
            serviceAccountName: krules-system
            containers:
              - name: webhook
                image: {{ digest }}
                ports: 
                  - containerPort: 8443
                    name: webhook-api
                env:
                  - name: PUBLISH_PROCEVENTS_LEVEL
                    value: "2"
                  - name: PUBLISH_PROCEVENTS_MATCHING
                    value: "*"
                  - name: K_PROCEVENTS_SINK
                    value: http://broker-ingress.knative-eventing.svc.cluster.local/dev8850/procevents
                  - name: LOGGING_LEVEL
                    value: "20"
                volumeMounts:
                  - name: {{ name }}-tls
                    mountPath: /run/secrets/tls
                    readOnly: true

            volumes:
              - name: {{ name }}-tls
                secret:
                    secretName: {{ name }}-tls
---
apiVersion: v1
kind: Service
metadata:
  name: {{ name }}
  namespace: {{ namespace}}
spec:
  selector:
    app: {{ name }}
  ports:
    - port: 443
      targetPort: webhook-api

---
apiVersion: eventing.knative.dev/v1
kind: Broker
metadata:
  name: default
  namespace: {{ namespace }}
---
apiVersion: sources.knative.dev/v1alpha2
kind: SinkBinding
metadata:
 name: {{ name }}
 namespace: {{ namespace }}
spec:
 subject:
   apiVersion: apps/v1
   kind: Deployment
   selector:
     matchLabels:
       app: {{ name }}
 sink:
   ref:
     apiVersion: eventing.knative.dev/v1beta1
     kind: Broker
     namespace: {{ namespace }}
     name: default


